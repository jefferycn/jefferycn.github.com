---
layout: post
title: "e4200 with tomato"
date: 2013-03-24 21:06
categories: E4200
---

**施工中 Under construction**

很早就想把折腾的过程记录下来, 一直都整理不出这一份心情. 就着胖胖的机器就快到了的这个当口, 就开动吧.

网上能搜到的资料并不多, 这里主要是做一个整理, 再加上自己遇到的一些问题以及解决方法.

## 我们刷机吧

开始刷机前弄清楚这几个问题:

- 了解你的路由器

> 姓名: E4200 v1
> 
> CPU: BCM4718
> 
> 内存: 64 MB
> 
> 闪存: 16 MB
> 

- 什么是30-30-30?

> 主要作用是清除NVRAM, 也叫做硬复位, 按住reset键以及在web界面`恢复出厂设置`是不能清除NVRAM的. 刷机前后各操作一次. _**也有人说刷DDWRT才需要做硬复位, 但是保险起见, 你懂的**_
> 
> Hard Reset 30/30/30
> 
> 捅RESET之前你先确保DD固件里面的RESET功能是打开了的，一般这个选项是默认打开的！
> 
> 首先将路由器通电，接着捅RESET孔直到第一个30秒结束，接着在不松掉RESET的前提下，将电源断掉等待30秒，最后将电源在> 插上去再继续压着RESET孔30秒！就完成这个步骤了！
> 
> 这里我要说的是整个过程不能松掉RESET孔！也就是说你要按RESET一直90秒！
> 
> 需要注意的是有些路由器在这个步骤之后一段时间后，一定要拔掉电源再插上电源才能正常启动！
> 

- 刷 tomato 之前, 需要先刷 ddwrt 吗? 

> 不需要. 直接官方固件web端升级 Tomato 即可.

- 哪里才能下载到最新的固件?

> Tomato 有很多版本. 我这里用的是 Shibby 的版本.
> 
> 下载地址: [http://tomato.groov.pl/?page_id=164](http://tomato.groov.pl/?page_id=164)
>
> 支持E4200的版本这里有两种 K26 和 K26RT-N. K26 是不支持5G的版本, K26RT-N支持双频.
> 打开链接, 选择最新版本, 通常最新版就是最稳定的版本. 在目录 build5x-108-EN > Linksys E-series 中, 找到 `tomato-E4200USB-NVRAM60K` 开头的文件. 后缀为 `AIO` 的为全功能版, 一般为我们使用的版本.

- 特别提醒

> * 最好使用IE（不要用IE外壳软件）登陆路由器进行刷机操作，Firefox有可能导致刷机失误！
> * **不能使用无线连接上传固件，必须用网线链接路由器上传固件！**
> * 不能通过 SSL (https) 连接刷新固件、备份固件！
> * 不能在路由器刷新固件及重启时打断安装过程！
> * 不能在刷机过程中关闭电脑、关闭浏览器或者关闭路由器！
> * 不能用旧版固件中备份出的配置文件，刷机前后必须将路由器恢复至默认设置！
> * 跳过这些步骤，路由器可能会变砖！
> 

### 好了,看到这里我想你已经可以愉快的看到番茄的管理界面了. 纳尼? 还没开始? 好吧, 再写一次完整的刷机顺序:

1. 下载固件, 注意检查文件完整性
2. 硬复位
3. 网线连接电脑和路由器
4. 进入管理界面
5. 选择下载的固件进行升级
6. 升级大概持续5分钟
7. 硬复位
8. 完成

## 开始折腾她吧

# 安装 OPTWARE

# 使用USB口,完全简单NAS功能

# 使用脚本下载迅雷离线的资源

要在E4200上使用该迅雷离线下载脚本,需要修改一些源码,来使工具正常运行

修改 `lixian_cli.py`

	#!/usr/bin/env python

to

	#!/opt/bin/python2.7

修改 `lixian_download_tools.py`

	wget_opts = ['wget', '--header=Cookie: gdriveid='+gdriveid, download_url, '-O', filename]

to

	wget_opts = ['/opt/bin/wget', '--header=Cookie: gdriveid='+gdriveid, download_url, '-O', filename]

修改完成以后,放入`/opt/bin`目录
	
	mv /mnt/DATA/lixian /opt/bin/

给下载脚本创建一个更短的名字,方便输入
	
	#昵称 "迅雷"
	ln -s /opt/bin/lixian/lixian_cli.py /opt/bin/xl
	#昵称 "离线"
	ln -s /opt/bin/lixian/lixian_cli.py /opt/bin/lx

创建配置文件

	lx config username
	lx config password
	lx config no-hash
	lx config continue
	lx config output-dir=/mnt/DATA/download/
	lx config -- aria2-opts "--event-poll=select --max-tries=0"
	lx config -- wget-opts "--tries=0 --retry-connrefused"
	mv /root/.xunlei.lixian.config /opt/bin/lixian


[https://github.com/iambus/xunlei-lixian](https://github.com/iambus/xunlei-lixian)

# 安装lighttpd, 配合Apple TV播放带字幕的MP4视频

appletvv2 源码 [http://hdweb.googlecode.com/svn/ATV/appletvv2/](http://hdweb.googlecode.com/svn/ATV/appletvv2/)

# 在路由器上安装 autossh

-----------------------------------
下面是未整理信息
-----------------------------------

ssh rsa key not working

嗯,原因很明确,默认的root目录是在tmp里面,重启以后会被清空

```
/tmp/home/root
```

我的解决办法是: 打开jffs, 然后在里头创建一个目录, 用于存放root用户的各种文件, 当然包括ssh的信息了.

```
cd /jffs/

mkdir -p home/root

mount -o bind /jffs/home/root /root
```

参考文档
========================
1. [【分享】Cisco Linksys E4200/E3000/E2000 无线路由器刷第三方固件DD-WRT和Tomato教程](http://www.right.com.cn/forum/thread-74887-1-1.html)
2. [[分享]劫持MLB.TV，打造自己的Apple TV本地媒体浏览器（1.3版支持SRT和连续播放）](http://bbs.weiphone.com/read-htm-tid-5460032.html)